#!/bin/bash
#======================================================
#   System Required:  Debian 10+ 
#   Description: Manage clash
#   Author: J. 20211219
#======================================================


end="\033[0m"
black="\033[0;30m"
blackb="\033[1;30m"
white="\033[0;37m"
whiteb="\033[1;37m"
red="\033[0;31m"
redb="\033[1;31m"
green="\033[0;32m"
greenb="\033[1;32m"
yellow="\033[0;33m"
yellowb="\033[1;33m"
blue="\033[0;34m"
blueb="\033[1;34m"
purple="\033[0;35m"
purpleb="\033[1;35m"
lightblue="\033[0;36m"
lightblueb="\033[1;36m"


sh_ver="3.0.4"


url_cdn="https://gh.404delivr.workers.dev"

cpu=$(hostnamectl | grep Architecture: | awk '{print $2}')

system=$(cat /etc/issue | awk '{print $1}')
gateway=$(cat /etc/network/interfaces |grep gateway | awk '{print $2}' | head -n 1)

local_ip=$(ip a 2>&1 | grep -w 'inet' | grep 'global' | grep -E '\ 1(92|0|72|00|1)\.' | sed 's/.*inet.//g' | sed 's/\/[0-9][0-9].*$//g' | head -n 1);


eth_n=$(ip --oneline link show up | grep -v "lo" | awk '{print$2;exit}' | cut -d':' -f1 | cut -d'@' -f1)



webget2(){
	#å‚æ•°ã€$1ã€‘ä»£è¡¨ä¸‹è½½ç›®å½•ï¼Œã€$2ã€‘ä»£è¡¨åœ¨çº¿åœ°å€
	#å‚æ•°ã€$3ã€‘ä»£è¡¨è¾“å‡ºæ˜¾ç¤ºï¼Œã€$4ã€‘ä¸å¯ç”¨é‡å®šå‘
	if curl --version > /dev/null 2>&1;then
		[ "$3" = "echooff" ] && progress='-s' || progress='-#'
		[ -z "$4" ] && redirect='-L' || redirect=''
		result=$(curl -w %{http_code} --connect-timeout 5 $progress $redirect -ko $1 $2)
	else
		if wget --version > /dev/null 2>&1;then
			[ "$3" = "echooff" ] && progress='-q' || progress='-q --show-progress'
			[ "$4" = "rediroff" ] && redirect='--max-redirect=0' || redirect=''
			certificate='--no-check-certificate'
			timeout='--timeout=3'
		fi
		[ "$3" = "echoon" ] && progress=''
		[ "$3" = "echooff" ] && progress='-q'
		wget $progress $redirect $certificate $timeout -O $1 $2 
		[ $? -eq 0 ] && result="200"
	fi
}


# check root
[[ $EUID -ne 0 ]] && echo -e "${red}é”™è¯¯:  å¿…é¡»ä½¿ç”¨rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬!\n${end}" && exit 1

# check os
if cat /etc/issue | grep -Eqi "debian"; then
    release="debian"
elif cat /etc/issue | grep -Eqi "Armbian"; then
    release="Armbian"
else
    echo -e "${red}è¯·ä½¿ç”¨ Debianæˆ–Armbian ç³»ç»Ÿ!\n${end}" && exit 1
fi


os_version=""

# os version
if [[ -f /etc/os-release ]]; then
    os_version=$(awk -F'[= ."]' '/VERSION_ID/{print $3}' /etc/os-release)
fi
if [[ -z "$os_version" && -f /etc/lsb-release ]]; then
    os_version=$(awk -F'[= ."]+' '/DISTRIB_RELEASE/{print $2}' /etc/lsb-release)
fi

if [[ x"${release}" == x"debian" ]]; then
    if [[ ${os_version} -lt 10 ]]; then
        echo -e "${red}è¯·ä½¿ç”¨ Debian 10 æˆ–æ›´é«˜ç‰ˆæœ¬çš„ç³»ç»Ÿ!\n${end}" && exit 1
    fi
fi

confirm() {
    if [[ $# > 1 ]]; then
        echo && read -p "$1 [é»˜è®¤$2]: " temp
        if [[ x"${temp}" == x"" ]]; then
            temp=$2
        fi
    else
        read -p "$1 [y/n]: " temp
    fi
    if [[ x"${temp}" == x"y" || x"${temp}" == x"Y" ]]; then
        return 0
    else
        return 1
    fi
}



supervisor_config() {
cat << EOF > /etc/supervisor/supervisord.conf
; supervisor config file
[unix_http_server]
file=/var/run/supervisor.sock     ;UNIX socket æ–‡ä»¶ï¼Œsupervisorctl ä¼šä½¿ç”¨
chmod=0700                        ;socketæ–‡ä»¶çš„modeï¼Œé»˜è®¤æ˜¯0700
;chown=nobody:nogroup             ;socketæ–‡ä»¶çš„ownerï¼Œæ ¼å¼ï¼šuid:gid
;[inet_http_server]                ;HTTPæœåŠ¡å™¨ï¼Œæä¾›webç®¡ç†ç•Œé¢
;port=0.0.0.0:9089                 ;Webç®¡ç†åå°è¿è¡Œçš„IPå’Œç«¯å£ï¼Œå¦‚æœå¼€æ”¾åˆ°å…¬ç½‘ï¼Œéœ€è¦æ³¨æ„å®‰å…¨æ€§
;username=admin                    ;ç™»å½•ç®¡ç†åå°çš„ç”¨æˆ·å
;password=admin                    ;ç™»å½•ç®¡ç†åå°çš„å¯†ç 
[supervisord]
logfile=/tmp/supervisord.log     ;æ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ supervisord.log
pidfile=/var/run/supervisord.pid            ;pid æ–‡ä»¶
childlogdir=/var/log/supervisor
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock 	;é€šè¿‡UNIX socketè¿æ¥supervisordï¼Œè·¯å¾„ä¸unix_http_serveréƒ¨åˆ†çš„fileä¸€è‡´
;serverurl=http://127.0.0.1:9088 						;é€šè¿‡HTTPçš„æ–¹å¼è¿æ¥supervisord
[include]
files = /etc/supervisor/conf.d/*.conf
EOF
     sudo supervisorctl update >> /dev/null 2>&1
     sudo supervisorctl reload >> /dev/null 2>&1
}

supervisor_clash_config() {
cat << EOF > /etc/supervisor/conf.d/clash.conf
[program:clash]                                             ;ç®¡ç†clashè¿›ç¨‹
user=root                                                   ;å¯åŠ¨è¿›ç¨‹ç”¨æˆ·ï¼Œé»˜è®¤æ˜¯root
command=/usr/bin/clash -d /srv/clash/                       ;ç¨‹åºå¯åŠ¨å‘½ä»¤
autostart=true                                              ;åœ¨supervisordå¯åŠ¨çš„æ—¶å€™ä¹Ÿè‡ªåŠ¨å¯åŠ¨
startsecs=10                                                ;å¯åŠ¨åç¡®è®¤æ— å¼‚å¸¸æ—¶é—´
autorestart=true                                            ;ç¨‹åºé€€å‡ºåè‡ªåŠ¨é‡å¯,å¯é€‰å€¼ï¼š[unexpected,true,false]ï¼Œé»˜è®¤ä¸ºunexpectedï¼Œè¡¨ç¤ºè¿›ç¨‹æ„å¤–æ€æ­»åæ‰é‡å¯
startretries=3                                              ;å¯åŠ¨å¤±è´¥è‡ªåŠ¨é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯3
redirect_stderr=true 																				;æŠŠstderré‡å®šå‘åˆ°stdoutï¼Œé»˜è®¤false
stdout_logfile_maxbytes=20MB  															;stdout æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤50MB
stdout_logfile_backups = 5   													   		;stdout æ—¥å¿—æ–‡ä»¶å¤‡ä»½æ•°ï¼Œé»˜è®¤æ˜¯10
stdout_logfile=/tmp/clash.log						      	            ;stdout æ—¥å¿—æ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„å½“æŒ‡å®šç›®å½•ä¸å­˜åœ¨æ—¶æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼ˆsupervisord ä¼šè‡ªåŠ¨åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼‰
EOF
}

supervisor_mosdns_config() {
cat << EOF > /etc/supervisor/conf.d/mosdns.conf
[program:mosdns]                                            ;ç®¡ç†mosdnsè¿›ç¨‹
user=root                                                   ;å¯åŠ¨è¿›ç¨‹ç”¨æˆ·ï¼Œé»˜è®¤æ˜¯root
command=/usr/bin/mosdns -dir /srv/mosdns/ -c config.yaml    ;ç¨‹åºå¯åŠ¨å‘½ä»¤
autostart=true                                              ;åœ¨supervisordå¯åŠ¨çš„æ—¶å€™ä¹Ÿè‡ªåŠ¨å¯åŠ¨
startsecs=10                                                ;å¯åŠ¨åç¡®è®¤æ— å¼‚å¸¸æ—¶é—´
autorestart=true                                            ;ç¨‹åºé€€å‡ºåè‡ªåŠ¨é‡å¯,å¯é€‰å€¼ï¼š[unexpected,true,false]ï¼Œé»˜è®¤ä¸ºunexpectedï¼Œè¡¨ç¤ºè¿›ç¨‹æ„å¤–æ€æ­»åæ‰é‡å¯
startretries=3                                              ;å¯åŠ¨å¤±è´¥è‡ªåŠ¨é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯3
redirect_stderr=true 																				;æŠŠstderré‡å®šå‘åˆ°stdoutï¼Œé»˜è®¤false
stdout_logfile_maxbytes=20MB  															;stdout æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé»˜è®¤50MB
stdout_logfile_backups = 5   													   		;stdout æ—¥å¿—æ–‡ä»¶å¤‡ä»½æ•°ï¼Œé»˜è®¤æ˜¯10
#stdout_logfile=/tmp/mosdns.log								              ;stdout æ—¥å¿—æ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„å½“æŒ‡å®šç›®å½•ä¸å­˜åœ¨æ—¶æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨åˆ›å»ºç›®å½•ï¼ˆsupervisord ä¼šè‡ªåŠ¨åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼‰
EOF
}



dler_clash_config() {
     if [ ! -d "/srv/clash" ]; then
     mkdir /srv/clash
     fi  
cat << EOF > /srv/clash/config.yaml
# ç³»ç»Ÿå‚æ•°
port: 7890                        # HTTPä»£ç†ç«¯å£
socks-port: 7891                  # SOCKSä»£ç†ç«¯å£
redir-port: 7892                  # é€æ˜ä»£ç†ç«¯å£ï¼ˆfor Linux or MacOSï¼‰ä¸èƒ½æ›´æ”¹
mixed-port: 7893                  # é›†æˆç«¯å£ï¼Œhttpä¸socks
#authentication:                   # éªŒè¯
#  - "user:user"                 # httpä¸socksçš„è´¦å·è·Ÿå¯†ç ï¼Œæ¨èä½¿ç”¨
allow-lan: true                   # å…è®¸å±€åŸŸç½‘è¿æ¥
mode: Script                      # Rule or Script    # å·¥ä½œæ¨¡å¼ï¼ˆæœ‰Globalå…¨å±€ï¼ŒRuleè§„åˆ™ï¼ŒDirectç›´è¿,Scriptè„šæœ¬ï¼‰
log-level: info                   # æ—¥å¿—çº§åˆ«ï¼ˆinfo / warning / error / debug / silentï¼‰
ipv6: false                       # å‡
external-controller: 0.0.0.0:9090 # å¤–éƒ¨æ§åˆ¶é¢æ¿ç›‘å¬ç«¯å£
external-ui: dashboard            # å¤–éƒ¨æ§åˆ¶é¢æ¿ä»ªè¡¨æ¿
secret: ""                        # dashboardé¢æ¿çš„å¯†ç ï¼ŒåŒæ—¶ä¹Ÿæ˜¯tracingçš„å¯†ç 
interface-name: $eth_n            # ip a æŸ¥çœ‹æ¥å£åç§°ï¼Œç¡®è®¤ä¸€è‡´ 
profile:                          # æè¿°
  store-selected: true            # ç­–ç•¥ç»„é€‰æ‹©ç¼“å­˜å¼€å…³ï¼Œæ‰“å¼€åå¯ä»¥ä¿å­˜ç­–ç•¥ç»„é€‰æ‹©ï¼Œé‡å¯ä¸ä¼šå›å¤é»˜è®¤
  tracing: true                   # tracingå¼€å…³ï¼Œå¿…é¡»æ‰“å¼€æ‰èƒ½å¯¹æ¥tracing
# å®éªŒæ€§åŠŸèƒ½
experimental:
  ignore-resolve-fail: true
# TUNè®¾ç½®
tun:
  enable: true         
  stack: gvisor
  dns-hijack:
    - tcp://8.8.8.8:53
    - tcp://8.8.4.4:53
    - 8.8.8.8:53
    - 8.8.8.8:53
# DNSè®¾ç½®  
dns:
  enable: true
  ipv6: false
  listen: 127.0.0.1:5352         # DNSç›‘å¬ç«¯å£!!!clashä¸‹ï¼Œæ­¤å¤„ä¸èƒ½æ”¹ï¼Œåˆ‡è®°!!!!
  # DNSè§£ææ¨¡å¼ï¼ˆredir-host # or fake-ipï¼‰ï¼Œè¿™é‡Œé‡ç‚¹è§£é‡Šä¸€ä¸‹ï¼š
  # redir-hostä¸ºçœŸå®IPæ¨¡å¼ï¼Œéœ€è¦è®¾ç½®nameserverï¼ˆå›½å†…ï¼‰å’Œfallbackï¼ˆå›½å¤–ï¼‰ä¸¤ç»„DNSï¼Œå½“è®¾å¤‡å‘èµ·DNSè¯·æ±‚ï¼ŒCLASHä¼šåŒæ—¶å‘ä¸¤ç»„é‡Œé¢æ‰€æœ‰æœåŠ¡å™¨å‘èµ·è¯·æ±‚ï¼Œç„¶åé¦–å…ˆæ‹¿nameserverä¸­æœ€å¿«è¿”å›çš„ç»“æœå»åŒ¹é…è§„åˆ™ï¼Œä½¿ç”¨GEOIPåˆ¤æ–­æ­¤IPçš„æ‰€å±åŒºåŸŸï¼Œå¦‚æœå±äºå›½å†…ï¼ˆCNï¼‰æˆ–ä¿ç•™åœ°å€åˆ™ç›´æ¥å“åº”ç»™å®¢æˆ·ç«¯ï¼Œå…¶ä»–æƒ…å†µåˆ™æŠŠfallbackä¸­çš„ç»“æœå“åº”ç»™å®¢æˆ·ç«¯
  # fake-ipåˆ™ç›¸åï¼Œå½“clashæ”¶åˆ°è¯·æ±‚ï¼Œä¼šç›´æ¥è¿”å›ä¸€ä¸ª198.18.0.1/16çš„å‡IPç»™è®¾å¤‡ï¼ŒåŒæ—¶ Clash ç»§ç»­è§£æåŸŸåè§„åˆ™å’Œ IP è§„åˆ™ï¼Œè€Œä¸”å¦‚æœ Clash DNS åŒ¹é…åˆ°äº†åŸŸåè§„åˆ™ã€åˆ™ä¸éœ€è¦å‘ä¸Šæ¸¸ DNS è¯·æ±‚ï¼ŒClash å·²ç»å¯ä»¥ç›´æ¥å°†è¿æ¥å‘ç»™ä»£ç†æœåŠ¡å™¨ï¼ŒèŠ‚çœäº† Clash DNS å‘ä¸Šæ¸¸ DNS è¯·æ±‚è§£æ
  default-nameserver:
    - 223.5.5.5
    - 223.6.6.6
    - 8.8.8.8
    - 8.8.4.4
  enhanced-mode: fake-ip         # ç†è®ºä¸Šæ¥è¯´ï¼Œfake-ipå…·æœ‰æ›´å¥½çš„å“åº”é€Ÿåº¦è·ŸæŠ—æ±¡æŸ“èƒ½åŠ›ï¼ˆä¸»è¦è¿˜å¾—çœ‹è§„åˆ™ï¼‰ã€‚ç”±äºç¯å¡”æå‰åˆ†æµäº†å›½å†…å¤–æµé‡ï¼Œå›½å†…æµé‡ä¸ç»è¿‡clashï¼Œæ‰€ä»¥é€‰æ‹©fake-ipå¯ä»¥å¾—åˆ°æ›´å¥½çš„æ•ˆæœï¼Œå½“ç„¶ï¼Œè¿˜æ˜¯å¾—çœ‹è§„åˆ™å®Œä¸å®Œæ•´ã€‚æœ‰éœ€è¦è¿”å›çœŸå®IPçš„å¯ä»¥é€‰æ‹©redir-hostï¼Œè€å®è¯´ä¸¤ç§DNSæ¨¡å¼åœ¨å®é™…ä½“éªŒä¸­å·®åˆ«ä¸å¤§
  fake-ip-range: 198.19.0.1/16   # ipèŒƒå›´
  use-hosts: true                # å¼€å¯
  fake-ip-filter:                # fake-ipç™½åå•ï¼Œå¯¹äºæœ‰éœ€è¦è¿”å›çœŸå®IPåˆæƒ³ç”¨fake-ipçš„ï¼Œå¯å‚ç…§ä»¥ä¸‹æ ¼å¼æŠŠåŸŸååŠ è¿›å»
    - msftconnecttest.com
    - "*.msftconnecttest.com"
    - msftncsi.com
    - "*.msftncsi.com"
    - '.lan'
    - localhost.ptlogin2.qq.com    
    - '.srv.nintendo.net'   
    - '.stun.playstation.net'   
    - 'xbox.*.microsoft.com'    
    - '.xboxlive.com'
  nameserver:                    # DNSæœåŠ¡å™¨ï¼ˆå›½å†…ï¼‰ï¼Œæ­¤å¤„å»ºè®®åªå¡«ä¸€ä¸ªé€Ÿåº¦æœ€å¿«çš„DNSå°±å¯ä»¥äº†
    - 119.29.29.29
    - 119.28.28.28
    - 223.5.5.5
    - 223.6.6.6
    - 180.76.76.76
    - 1.2.4.8
# ä»¥ä¸‹å°±æ˜¯ä»£ç†ï¼Œä»£ç†é›†ï¼ˆéœ€æœºåœºæ”¯æŒï¼‰ï¼Œç­–ç•¥ç»„è®¾ç½®ã€‚è¯·è‡ªå·±è§‚å¯Ÿï¼Œæ³¨æ„ä¹‹é—´çš„å¯¹åº”å…³ç³»!
# ä»£ç†é›†è®¾ç½®    
proxy-providers:
  ğŸ‡­ğŸ‡° é¦™æ¸¯:                   # ä»£ç†é›†åç§°
    type: http                   # ä»£ç†é›†ç±»å‹ï¼Œæœ‰httpï¼ˆç½‘ç»œåœ°å€ï¼‰è·Ÿfileï¼ˆæœ¬åœ°ï¼‰ä¸¤ç§æ ¼å¼
    path: ./ğŸ‡­ğŸ‡° é¦™æ¸¯.yaml     # ä»£ç†é›†æœ¬åœ°è·¯å¾„
    url: https://dler.cloud/subscribe/$token?protocols=ss&list=clash&match=é¦™æ¸¯
    interval: 28800             # è‡ªåŠ¨æ£€æµ‹æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œæ„æ€å°±æ˜¯æ¯28800æ›´æ–°ä¸€æ¬¡
    health-check:                # çŠ¶æ€æ£€æµ‹
      enable: true               # å¼€å¯
      url: http://cp.cloudflare.com/generate_204  # æ£€æµ‹åœ°å€ï¼Œæ¯600ç§’ä»£ç†é›†é‡Œé¢çš„èŠ‚ç‚¹å‘æ£€æµ‹åœ°å€åšä¸€æ¬¡è¿é€šæ€§æµ‹è¯•
      interval: 300              # è‡ªåŠ¨æ£€æµ‹æ—¶é—´ï¼Œå•ä½ä¸ºç§’
  ğŸ‡°ğŸ‡· éŸ©å›½:
    type: http
    path: ./ğŸ‡°ğŸ‡· éŸ©å›½.yaml
    url: https://dler.cloud/subscribe/$token?protocols=ss&list=clash&match=éŸ©å›½
    interval: 28800
    health-check:
      enable: true
      url: http://cp.cloudflare.com/generate_204
      interval: 300
  ğŸ‡ºğŸ‡¸ ç¾å›½:
    type: http
    path: ./ğŸ‡ºğŸ‡¸ ç¾å›½.yaml
    url: https://dler.cloud/subscribe/$token?protocols=ss&list=clash&match=ç¾å›½
    interval: 28800
    health-check:
      enable: true
      url: http://cp.cloudflare.com/generate_204
      interval: 300 
  ğŸ‡¯ğŸ‡µ æ—¥æœ¬:
    type: http
    path: ./ğŸ‡¯ğŸ‡µ æ—¥æœ¬.yaml
    url: https://dler.cloud/subscribe/$token?protocols=ss&list=clash&match=æ—¥æœ¬
    interval: 28800
    health-check:
      enable: true
      url: http://cp.cloudflare.com/generate_204
      interval: 300          
  ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡:
    type: http
    path: ./ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡.yaml
    url: https://dler.cloud/subscribe/$token?protocols=ss&list=clash&match=æ–°åŠ å¡
    interval: 28800
    health-check:
      enable: true
      url: http://cp.cloudflare.com/generate_204
      interval: 300   
  ğŸ‡¨ğŸ‡³ å°æ¹¾:
    type: http
    path: ./ğŸ‡¨ğŸ‡³ å°æ¹¾.yaml
    url: https://dler.cloud/subscribe/$token?protocols=ss&list=clash&match=å°æ¹¾
    interval: 28800
    health-check:
      enable: true
      url: http://cp.cloudflare.com/generate_204
      interval: 600          
# ç­–ç•¥ç»„
proxy-groups:
  - name: ğŸ“¶ å¸¦å®½æµ‹é€Ÿ
    type: select
    proxies:
      - ğŸ“¡ ç›´è¿å›½å†…
    use:  
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰                          
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬ 
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
  - name: ğŸŒ è°·æ­ŒæœåŠ¡
    type: select
    proxies:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬ 
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾ 
      - ğŸ“¡ ç›´è¿å›½å†…    
  - name: ğŸ’¬ å³æ—¶é€šè®¯
    type: select
    proxies:
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬ 
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾ 
      - ğŸ“¡ ç›´è¿å›½å†…  
  - name: ğŸ¦ Netflix
    type: select
    proxies:
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ“¡ ç›´è¿å›½å†…  
  - name: â–¶ï¸ Youtube
    type: select
    proxies:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
      - ğŸ“¡ ç›´è¿å›½å†…  
  - name: ğŸ“º æ¸¯æ¾³å°åŒº
    type: select
    proxies:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
      - ğŸ“¡ ç›´è¿å›½å†…  
  - name: ğŸ Disney
    type: select
    proxies:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
      - ğŸ“¡ ç›´è¿å›½å†…  
  - name: ğŸ å›½é™…åª’ä½“
    type: select
    proxies:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
      - ğŸ“¡ ç›´è¿å›½å†…  
  - name: ğŸŒ å›½é™…äº’è”
    type: select
    proxies:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
      - ğŸ“¡ ç›´è¿å›½å†…     
  - name: ğŸ¥ å›½å†…åª’ä½“
    type: select
    proxies:
      - ğŸ“¡ ç›´è¿å›½å†…
      - ğŸŒ å›½é™…äº’è”
  - name: ğŸ“§ å¾®è½¯æœåŠ¡
    type: select
    proxies:    
      - ğŸŒ å›½é™…äº’è”
      - ğŸ“¡ ç›´è¿å›½å†…
  - name: ğŸ“± è‹¹æœæœåŠ¡
    type: select
    proxies: 
      - ğŸ“¡ ç›´è¿å›½å†…
      - ğŸŒ å›½é™…äº’è”
  - name: ğŸ® æ¸¸æˆå¹³å°
    type: select
    proxies:
      - ğŸ“¡ ç›´è¿å›½å†…    
      - ğŸŒ å›½é™…äº’è”
  - name: â›”ï¸ æ‹¦æˆªå¹¿å‘Š
    type: select
    proxies:
      - ğŸš« æ‹¦æˆªé˜»æ–­
      - ğŸ“¡ ç›´è¿å›½å†…
  - name: ğŸ  æ¼ç½‘ä¹‹é±¼
    type: select
    proxies:
      - ğŸŒ å›½é™…äº’è”
      - ğŸ“¡ ç›´è¿å›½å†…    
  - name: ğŸš« æ‹¦æˆªé˜»æ–­
    type: select
    proxies:
      - REJECT 
  - name: ğŸ“¡ ç›´è¿å›½å†…
    type: select
    proxies:
      - DIRECT
#  - name: ğŸ® æ¸¸æˆåŠ é€Ÿ
#    type: select
#    use:   
#      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
#      - ğŸ‡°ğŸ‡· éŸ©å›½
#      - ğŸ‡ºğŸ‡¸ ç¾å›½
#      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬ 
#      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
#      - ğŸ‡¨ğŸ‡³ å°æ¹¾
#    proxies:
#      - ğŸ“¡ ç›´è¿å›½å†…    
  - name: ğŸ¤Ÿ æ‰‹åŠ¨é€‰æ‹©
    type: select
    use:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯                      #å¼•ç”¨ï¼ˆä»£ç†é›†æ–‡ä»¶ï¼‰
      - ğŸ‡°ğŸ‡· éŸ©å›½
      - ğŸ‡ºğŸ‡¸ ç¾å›½
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
  - name: ğŸ‡°ğŸ‡· éŸ©å›½
    type: url-test
    use:
      - ğŸ‡°ğŸ‡· éŸ©å›½
    url: http://cp.cloudflare.com/generate_204
    tolerance: 10
    interval: 300
  - name: ğŸ‡­ğŸ‡° é¦™æ¸¯
    type: url-test
    use:
      - ğŸ‡­ğŸ‡° é¦™æ¸¯
    url: http://cp.cloudflare.com/generate_204
    tolerance: 10
    interval: 300
  - name: ğŸ‡ºğŸ‡¸ ç¾å›½
    type: url-test
    use:
      - ğŸ‡ºğŸ‡¸ ç¾å›½
    url: http://cp.cloudflare.com/generate_204
    tolerance: 10
    interval: 300
  - name: ğŸ‡¯ğŸ‡µ æ—¥æœ¬
    type: url-test
    use:
      - ğŸ‡¯ğŸ‡µ æ—¥æœ¬
    url: http://cp.cloudflare.com/generate_204
    tolerance: 10
    interval: 300   
  - name: ğŸ‡¨ğŸ‡³ å°æ¹¾
    type: url-test
    use:
      - ğŸ‡¨ğŸ‡³ å°æ¹¾
    url: http://cp.cloudflare.com/generate_204
    tolerance: 10
    interval: 300     
  - name: ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
    type: url-test
    use:
      - ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡
    url: http://cp.cloudflare.com/generate_204
    tolerance: 10
    interval: 300       
# clashæœ‰å‡ ç§ç­–ç•¥ï¼Œurl-testè‡ªåŠ¨æµ‹é€Ÿï¼Œselectæ‰‹åŠ¨é€‰æ‹©ï¼Œselectä¸»å¤‡åˆ‡æ¢ï¼Œloadbalanceè½®è¯¢å‡è¡¡ï¼Œrelayä¸­ç»§æ¨¡å¼ï¼Œæ¯ä¸ªéƒ½æœ‰ä»–çš„ä¼˜åŠ£
# url-testè‡ªåŠ¨æµ‹é€Ÿ: è‡ªåŠ¨æµ‹é€Ÿï¼Œæˆ‘ç”¨çš„æœ€å¤šï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ŒèŠ‚ç‚¹è‡ªåŠ¨å‘æµ‹é€Ÿç‚¹å‘èµ·è¿æ¥æµ‹é€Ÿï¼Œç„¶åè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªå»¶è¿Ÿæœ€ä½çš„ï¼Œä½†è¿™ä¸ªä¸æ˜¯æœ¬åœ°åˆ°èŠ‚ç‚¹ï¼Œè€Œæ˜¯èŠ‚ç‚¹åˆ°æµ‹é€Ÿç‚¹.
# selectæ‰‹åŠ¨é€‰æ‹©: æ‰‹åŠ¨é€‰æ‹©ï¼Œé¡¾åæ€ä¹‰ï¼Œæ‰‹åŠ¨ï¼Œä¸ä¼šè‡ªåŠ¨åˆ‡æ¢.
# selectä¸»å¤‡åˆ‡æ¢: ä¸»å¤‡åˆ‡æ¢ï¼ŒèŠ‚ç‚¹å…ˆå‘èµ·æµ‹é€Ÿï¼Œç„¶åé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„èŠ‚ç‚¹ï¼Œä¸€å®šæ—¶é—´å†…åœ¨æµ‹é€Ÿï¼Œå¦‚æœé€‰æ‹©çš„èŠ‚ç‚¹æŒ‚äº†ï¼Œå°±é¡ºä½æ¢ï¼Œä¸æŒ‚å°±ç»§ç»­ç”¨ï¼Œä½†ä¸è€ƒè™‘å»¶è¿Ÿ.
# loadbalanceè½®è¯¢å‡è¡¡: è½®è®­å‡è¡¡ï¼Œè·Ÿè´Ÿè½½å‡è¡¡å·®ä¸å¤šï¼Œä½†æ²¡ä»€ä¹ˆç”¨.
# relayä¸­ç»§æ¨¡å¼: ä¸­ç»§æ¨¡å¼ï¼Œå°±æ˜¯å¯ä»¥è‡ªå®šä¹‰å¤šä¸ªèŠ‚ç‚¹çš„ä¸­ç»§è¡Œä¸º 
#è§„åˆ™é›†
rule-providers:
## > å»å¹¿å‘Š
  AdBlock1:                                   # è§„åˆ™é›†æ–‡ä»¶å
    type: http                                # è§„åˆ™é›†æ–‡ä»¶ç±»å‹ï¼ˆHTTP=åœ¨çº¿ä¸‹è½½ï¼›File=æœ¬åœ°å¯¼å…¥ï¼‰
    behavior: classical                       # è¡Œä¸ºåŸŸ
    path: ./ruleset/å¹¿å‘Šæ‹¦æˆª/AdBlock1.list     # è§„åˆ™é›†åœ¨çº¿ä¸‹è½½ä¿å­˜åœ°å€æˆ–æœ¬åœ°æ–‡ä»¶å¯¼å…¥åœ°å€
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e5%b9%bf%e5%91%8a%e6%8b%a6%e6%88%aa/AdBlock1.list  #è§„åˆ™é›†æ–‡ä»¶ä¸‹è½½åœ°å€
    interval: 43200                           # è§„åˆ™é›†æ–‡ä»¶è‡ªåŠ¨æ›´æ–°é—´éš”
  AdBlock2:
    type: http
    behavior: classical
    path: ./ruleset/å¹¿å‘Šæ‹¦æˆª/AdBlock2.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e5%b9%bf%e5%91%8a%e6%8b%a6%e6%88%aa/AdBlock2.list
    interval: 43200
  AdBlock3:
    type: http
    behavior: classical
    path: ./ruleset/å¹¿å‘Šæ‹¦æˆª/AdBlock3.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e5%b9%bf%e5%91%8a%e6%8b%a6%e6%88%aa/AdBlock3.list
    interval: 43200
  AdBlock4:
    type: http
    behavior: classical
    path: ./ruleset/å¹¿å‘Šæ‹¦æˆª/AdBlock4.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%B9%BF%E5%91%8A%E6%8B%A6%E6%88%AA/AdBlock4.list
    interval: 43200
  AdBlock5:
    type: http
    behavior: classical
    path: ./ruleset/å¹¿å‘Šæ‹¦æˆª/AdBlock5.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e5%b9%bf%e5%91%8a%e6%8b%a6%e6%88%aa/AdBlock5.list
    interval: 43200
## > åª’ä½“æœåŠ¡
  # > æ²¹ç®¡
  YouTube:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/YouTube.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/YouTube.list
    interval: 43200
  # > å¥ˆé£
  Netflix:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/Netflix.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/Netflix.list
    interval: 43200
  # > è¿ªå£«å°¼+
  Disney:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/Disney.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/Disney.list
    interval: 43200
  # > HBO
  HBO:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/HBO.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/HBO.list
    interval: 43200
  # > æ¸¯æ¾³å°åª’ä½“
  HMTmedia:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/HMTmedia.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/HMTmedia.list
    interval: 43200
  # > æ²¹ç®¡éŸ³ä¹   
  YoutubeMusic:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/YoutubeMusic.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/YoutubeMusic.list
    interval: 43200
  # > Apple TV
  AppleTV:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/AppleTV.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e5%aa%92%e4%bd%93%e6%9c%8d%e5%8a%a1/AppleTV.list
    interval: 43200
  # > å…¶ä½™å›½é™…æµåª’ä½“
  GlobalMedia:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/GlobalMedia.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/GlobalMedia.list
    interval: 43200
  # > å›½å†…æµåª’ä½“
  Chinesemedia:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/Chinesemedia.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/Chinesemedia.list
    interval: 43200
  # ç½‘æ˜“äº‘
  wyy:
    type: http
    behavior: classical
    path: ./ruleset/åª’ä½“æœåŠ¡/wyy.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1/wyy.list
    interval: 43200    
## > ç½‘ç»œæœåŠ¡
  # > è‹¹æœæœåŠ¡
  # è‹¹æœAPI
  AppleAPI:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/AppleAPI.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1/AppleAPI.list
    interval: 43200
  # è‹¹æœCDN
  AppleCDN:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/AppleCDN.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/AppleCDN.list
    interval: 43200
  # è°·æ­ŒæœåŠ¡
  Google:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Google.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1/Google.list
    interval: 43200
  # > è°·æ­ŒCDN
  GoogleCDN:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/GoogleCDN.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1/GoogleCDN.list
    interval: 43200
  # å¾®è½¯æœåŠ¡
  Microsoft:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Microsoft.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Microsoft.list
    interval: 43200
  # > å¾®è½¯CDN
  MicrosoftCDN:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/MicrosoftCDN.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/MicrosoftCDN.list
    interval: 43200
  # æ•°å­—è´§å¸
  Digital:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Digital.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Digital.list
    interval: 43200    
  # Paypal
  Paypal:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Paypal.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Paypal.list
    interval: 43200
  # Speedtest
  Speedtest:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Speedtest.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Speedtest.list
    interval: 43200
  # å³æ—¶é€šè®¯ï¼ˆTG,KAKAO,LINE....)
  Telegram:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Telegram.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Telegram.list
    interval: 43200
  # æ¸¸æˆå¹³å°ï¼ˆSteam,xbox,PS,æˆ˜ç½‘ï¼‰
  gameline:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/gameline.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/gameline.list
    interval: 43200
  # > å›å›½çº¿è·¯ 
  Domestic:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Domestic.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Domestic.list
    interval: 43200
  Lan:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Lan.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/Lan.list
    interval: 43200
  # > å›½é™…äº’è”
  Proxy:
    type: http
    behavior: classical
    path: ./ruleset/ç½‘ç»œæœåŠ¡/Proxy.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%e7%bd%91%e7%bb%9c%e6%9c%8d%e5%8a%a1/Proxy.list
    interval: 43200
## > é»‘ç™½åå•
  # > é»‘åå•
  Black:
    type: http
    behavior: classical
    path: ./ruleset/é»‘ç™½åå•/Black.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95/Black.list
    interval: 43200
  # > ç™½åå•
  White:
    type: http
    behavior: classical
    path: ./ruleset/é»‘ç™½åå•/White.list
    url: https://raw.githubusercontent.com/clash1step/rule-provider/master/%E9%BB%91%E7%99%BD%E5%90%8D%E5%8D%95/White.list
    interval: 43200
# ScriptåŒ¹é…æ¨¡å¼
script:
    code: |
    
        def main(ctx, metadata):
        ## >> è‡ªå®šä¹‰å˜é‡
            # æ¸¸æˆä¸»æœºç­–ç•¥               
            #SrcIP = ctx.resolve_ip(metadata["src_ip"])
            #if SrcIP == "10.10.10.14":
                #if metadata["network"] == "udp":
                    #ctx.log('[Script] matched SrcIP')
                    #return "ğŸ® æ¸¸æˆåŠ é€Ÿ"
                #return "ğŸŒ å›½é™…äº’è”"
                
            # å¹¿å‘Šæ‹¦æˆªç­–ç•¥
            ad_action = {
                "Speedtest": "ğŸ“¶ å¸¦å®½æµ‹é€Ÿ",
                "AdBlock1": "â›”ï¸ æ‹¦æˆªå¹¿å‘Š",
                "AdBlock2": "â›”ï¸ æ‹¦æˆªå¹¿å‘Š",
                "AdBlock3": "â›”ï¸ æ‹¦æˆªå¹¿å‘Š",
                "AdBlock4": "â›”ï¸ æ‹¦æˆªå¹¿å‘Š",
                "AdBlock5": "â›”ï¸ æ‹¦æˆªå¹¿å‘Š"
                }
            ad_rule = ["Speedtest","AdBlock1", "AdBlock2", "AdBlock3", "AdBlock4", "AdBlock5"]
            for ad_name in ad_rule:
                if ctx.rule_providers[ad_name].match(metadata):
                    ctx.log('[Script] matched %s' % ad_name)
                    return ad_action[ad_name]
                    
            # Plexç­–ç•¥
            #plex_direct = ["+.plex.direct"]
            #plex_tv = ["+.plex.tv"]
            #for hostname in plex_direct:
                #if hostname in metadata["host"]:
                    #ctx.log('[Script] matched %s' % hostname)
                    #return "ğŸ˜å›å®¶"
            #for hostname in plex_tv:
                #if hostname in metadata["host"]:
                    #ctx.log('[Script] matched %s' % hostname)
                    #return "ğŸŒ å›½é™…äº’è”"
          
            # å®šä¹‰è§„åˆ™é›†ä¸ç­–ç•¥ç»„
            ruleset_action = {
                "Lan": "ğŸ“¡ ç›´è¿å›½å†…",
                "White": "ğŸ“¡ ç›´è¿å›½å†…",
                "Black": "ğŸŒ å›½é™…äº’è”",
                "Telegram": "ğŸ’¬ å³æ—¶é€šè®¯",
                "YouTube": "â–¶ï¸ Youtube",
                "Netflix": "ğŸ¦ Netflix",
                "HMTmedia": "ğŸ“º æ¸¯æ¾³å°åŒº",
                "Disney": "ğŸ Disney",
                "YoutubeMusic": "ğŸ å›½é™…åª’ä½“",
                "HBO": "ğŸ å›½é™…åª’ä½“",
                "AppleTV": "ğŸ å›½é™…åª’ä½“",
                "GlobalMedia": "ğŸ å›½é™…åª’ä½“", 
                "gameline": "ğŸ® æ¸¸æˆå¹³å°",               
                "Digital": "ğŸŒ å›½é™…äº’è”",
                "Paypal": "ğŸŒ å›½é™…äº’è”",
                "Proxy": "ğŸŒ å›½é™…äº’è”",
                "wyy": "ğŸ¥ å›½å†…åª’ä½“",
                "Chinesemedia": "ğŸ¥ å›½å†…åª’ä½“",
                "AppleAPI": "ğŸ“± è‹¹æœæœåŠ¡",
                "Google": "ğŸŒ è°·æ­ŒæœåŠ¡",
                "GoogleCDN": "ğŸŒ è°·æ­ŒæœåŠ¡",
                "Microsoft": "ğŸ“§ å¾®è½¯æœåŠ¡",
                "AppleCDN": "ğŸ“¡ ç›´è¿å›½å†…",                  
                "MicrosoftCDN": "ğŸ“¡ ç›´è¿å›½å†…",            
                "Domestic": "ğŸ“¡ ç›´è¿å›½å†…"
                }
            name_rule = ["Lan","White","Black","Telegram","YouTube","Netflix","HMTmedia","Disney","YoutubeMusic","HBO","AppleTV","GlobalMedia","gameline","Google","Digital","Paypal","Proxy","wyy","Chinesemedia","AppleAPI","GoogleCDN","Microsoft","AppleCDN","MicrosoftCDN","Domestic"]
            # ç­–ç•¥ç»„è§„åˆ™
            for rule_name in name_rule:
                if ctx.rule_providers[rule_name].match(metadata):
                    ctx.log('[Script] matched %s' % rule_name)
                    return ruleset_action[rule_name]              
            # æ¼ç½‘ä¹‹é±¼
            return "ğŸ  æ¼ç½‘ä¹‹é±¼"
EOF
}


mosdns_config() {
cat << EOF > /srv/mosdns/config.yaml
################# æ—¥å¿— ################
log:
  level: info           
  file: /tmp/mosdns.log    
  ################# å¿…è¦æ’ä»¶ ################
plugin:
  - tag: main_server                
    type: server                    
    args:                           
      entry: main_sequence         
      max_concurrent_queries: 0     
      server:                       
        - protocol: udp             
          addr: 0.0.0.0:53          
          timeout: 5                
        - protocol: tcp
          addr: 0.0.0.0:53
          timeout: 5
          idle_timeout: 10          
################# å¯æ‰§è¡Œæ’ä»¶ ################
  - tag: main_sequence      
    type: sequence          
    args:                           
      exec:   
        - hosts
        - if:
            - adblock_list               
          exec:       
            - _block_with_empty_response              
            - _end
        - if:
            - black_list                 
          exec:       
            - forward_clash              
            - _end 
        - forward_clash
        - if:
            - white_list
            - direct_list           
          exec:
            - forward_direct         
            - _end
################ è§£ææœåŠ¡å™¨æ’ä»¶ #################
##### è§£æç›´è¿åŸŸåçš„æ’ä»¶ï¼Œdirect #####
  - tag: forward_direct
    type: fast_forward                   
    args:    
      upstream:     
        - addr: 119.29.29.29
          trusted: true
          idle_timeout: 30
          max_conns: 5
        - addr: 223.6.6.6
          trusted: true
          idle_timeout: 30
          max_conns: 5
        - addr: 114.114.114.114
          trusted: true
          idle_timeout: 30
          max_conns: 5          
      timeout: 2
 
##### è§£æä»£ç†åŸŸåçš„æ’ä»¶ï¼Œclash #####
  - tag: forward_clash
    type: fast_forward
    args:
      upstream:
          addr: 127.0.0.1:5352
          trusted: true
################ åŒ¹é…å™¨æ’ä»¶ #################
##### åŒ¹é…å¹¿å‘ŠåŸŸåçš„æ’ä»¶ #####
  - tag: adblock_list
    type: query_matcher
    args:
      domain:
         - ext:./ad/adblock.china.list
         - ext:./ad/adblock.global.list
         - ext:./ad/adblock.list     
         - ext:./geosite.dat:category-ads-all
##### åŒ¹é…é»‘åå•çš„æ’ä»¶ #####
  - tag: black_list                   
    type: query_matcher
    args:
      domain:
        - ext:./global/black.list
        - ext:./global/proxy.list
        - ext:./geosite.dat:google
        - ext:./geosite.dat:geolocation-!cn
##### åŒ¹é…ç™½åå•çš„æ’ä»¶ #####        
  - tag: white_list                   
    type: query_matcher
    args:
      domain:
        - ext:./china/white.list
        - ext:./geosite.dat:apple-cn
        
##### åŒ¹é…ç›´è¿åŸŸå/IPçš„æ’ä»¶ #####
  - tag: direct_list                  
    type: query_matcher
    args:
      domain:
        - ext:./geosite.dat:cn
      client_ip:   
        - ext:./geoip.dat:cn     
        
##### åŒ¹é…hostsçš„æ’ä»¶ #####
  - tag: hosts
    type: hosts
    args:
      hosts:               
        - ext:./hosts/hosts.list 
        
include: [ ]
EOF
}


config_base() { 
echo -e "${green}ä¼˜åŒ–ç³»ç»Ÿ,è¯·ç¨å€™!${end}" 
# ä¼˜åŒ–å†…æ ¸å‚æ•°
cat << EOF > /etc/sysctl.conf
# å¼€å¯è½¬å‘
net.ipv4.ip_forward = 1
# ä¼˜åŒ–å‚æ•°
fs.file-max = 1024000
fs.nr_open = 1048576
kernel.msgmni = 4096
kernel.msgmax = 65536
kernel.msgmnb = 65536
kernel.shmmni = 1024
kernel.shmmax = 4294967296
kernel.shmall = 2097152
net.core.netdev_max_backlog = 262144
net.core.somaxconn = 262144
net.ipv4.tcp_max_syn_backlog = 262144
net.core.rmem_default = 4194304
net.core.wmem_default = 4194304
net.core.rmem_max = 12582912
net.core.wmem_max = 12582912
net.core.optmem_max = 81920
net.ipv4.tcp_mem = 65536 262144 8388608
net.ipv4.tcp_rmem = 10240 87380 12582912
net.ipv4.tcp_wmem = 10240 87380 12582912
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_fin_timeout = 10
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_base_mss = 1452
net.ipv4.tcp_fack = 1
net.ipv4.tcp_low_latency = 0
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.ip_local_port_range = 10000 65535
net.ipv4.ip_local_reserved_ports = 7892
net.ipv4.tcp_fastopen = 3
net.ipv4.ip_default_ttl = 128
net.ipv4.udp_mem = 65536 262144 8388608
net.ipv4.udp_rmem_min = 65535
net.ipv4.udp_wmem_min = 65535
net.ipv4.route.flush = 1
# ç¦ç”¨ipv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
# å¼€å¯ECNåŠ é€Ÿ
net.ipv4.tcp_ecn = 1
net.ipv4.tcp_ecn_fallback = 1
EOF

echo 'net.core.default_qdisc = fq_pie' | sudo tee /etc/sysctl.d/90-override.conf >> /dev/null 2>&1

sysctl -p >> /dev/null 2>&1

cat << EOF > /etc/security/limits.d/98-nofile.conf
# add lines to it
*     soft     nofile     524288
*     hard     nofile     524288
root  soft     nofile     524288
root  hard     nofile     524288
EOF

#echo 'ListenAddress 0.0.0.0'>>/etc/ssh/sshd_config
#echo 'AddressFamily inet'>>/etc/ssh/sshd_config

#service sshd restart

echo 'DNSStubListener=no'>>/etc/systemd/resolved.conf

}


config_ip_dns(){
echo -e "${green}é…ç½®ipä¿¡æ¯,è¯·ç¨å€™!${end}" 
rm -rf /etc/resolv.conf
cat << EOF > /etc/resolv.conf
nameserver $ip_dns
EOF

cat << EOF > /etc/network/interfaces
source /etc/network/interfaces.d/*
auto lo
iface lo inet loopback
auto $eth_n
iface $eth_n inet static
  address $ip_add
  netmask $ip_mask
  gateway $ip_gw
  dns-nameservers $ip_dns
  mtu 1492
  mss 1452
EOF
}

getcpucore(){
	cputype=$(uname -ms | tr ' ' '_' | tr '[A-Z]' '[a-z]')
  [ -n "$(echo $cputype | grep -E "linux.*armv7.*")" ] && [ -n "$(cat /proc/cpuinfo | grep vfp)" ] && cpucore="armv7"
	[ -n "$(echo $cputype | grep -E "linux.*aarch64.*|linux.*armv8.*")" ] && cpucore="armv8"
	[ -n "$(echo $cputype | grep -E "linux.*86_64.*")" ] && cpucore="amd64"
}

getcpucore2(){
	cputype2=$(uname -ms | tr ' ' '_' | tr '[A-Z]' '[a-z]')
  [ -n "$(echo $cputype2 | grep -E "linux.*armv7.*")" ] && [ -n "$(cat /proc/cpuinfo | grep vfp)" ] && cpucore2="armv7"
	[ -n "$(echo $cputype2 | grep -E "linux.*aarch64.*|linux.*armv8.*")" ] && cpucore2="arm64"
	[ -n "$(echo $cputype2 | grep -E "linux.*86_64.*")" ] && cpucore2="amd64"
}



install_debian() {


rm -rf /etc/apt/sources.list.d/*

cat << EOF > /etc/apt/sources.list
deb http://mirrors.aliyun.com/debian $(cat /etc/os-release | grep VERSION= | cut -d '(' -f2 | cut -d ')' -f1) main
deb http://mirrors.aliyun.com/debian-security $(cat /etc/os-release | grep VERSION= | cut -d '(' -f2 | cut -d ')' -f1)/updates main
deb http://mirrors.aliyun.com/debian $(cat /etc/os-release | grep VERSION= | cut -d '(' -f2 | cut -d ')' -f1)-updates main
EOF
echo -e "${green}å‡çº§ç³»ç»Ÿ,è¯·ç¨å€™! å¤§æ¦‚5-10åˆ†é’Ÿ!${end}" 
apt update >> /dev/null 2>&1
apt -y full-upgrade >> /dev/null 2>&1
apt -y autoclean >> /dev/null 2>&1 
echo -e "${green}ç³»ç»Ÿå‡çº§å®Œæˆ!${end}"


echo -e "${green}å®‰è£…è½¯ä»¶,è¯·ç¨å€™! å¤§æ¦‚5-10åˆ†é’Ÿ!${end}"     
apt -y install htop sudo strace supervisor curl wget unzip nftables ntpdate net-tools gawk >> /dev/null 2>&1
rm /etc/localtime
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
ntpdate cn.pool.ntp.org >> /dev/null 2>&1
chown -R root /srv/ >> /dev/null 2>&1
echo -e "${green}è½¯ä»¶å®‰è£…å®Œæˆ!${end}"

}

install_clash() {
     new_clash_ver=$( wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep clash_v | awk '{print $2}')
     if [[ ! -n "$new_clash_ver" ]]; then
     echo -e "${red}Clashæ£€æµ‹ç‰ˆæœ¬å¤±è´¥!${end}"
     exit 1
     fi      
     if [ ! -d "/tmp/clash" ]; then
     mkdir /tmp/clash
     fi 
     webget2 /tmp/clash/clash.gz "$url_cdn/https://github.com/Dreamacro/clash/releases/download/premium/clash-linux-${cpucore}-${new_clash_ver}.gz"
     if [[ $? -ne 0 ]]; then
     echo -e "${red}Clashä¸‹è½½å¤±è´¥!${end}"
     exit 1
     fi
     echo -e "${green}Clashä¸‹è½½æˆåŠŸ!${end}" 
     rm -rf /usr/bin/clash
     gunzip /tmp/clash/clash.gz
     mv /tmp/clash/clash /usr/bin/clash
     chmod +x /usr/bin/clash
     setcap cap_net_bind_service=+ep /usr/bin/clash
     webget2  /tmp/ui.tar.gz  ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/clash/ui.tar.gz >> /dev/null 2>&1
     if [[ $? -ne 0 ]]; then
     echo -e "${red}UIä¸‹è½½å¤±è´¥!${end}"
     exit 1
     fi
     echo -e "${green}UIä¸‹è½½æˆåŠŸ!${end}" 
     if [ ! -d "/srv/clash" ]; then
     mkdir /srv/clash
     fi 
     tar zxvf /tmp/ui.tar.gz  -C /srv/clash/ >> /dev/null 2>&1
     rm -rf /tmp/ui.tar.gz
     supervisor_clash_config
     supervisorctl update >> /dev/null 2>&1
     supervisorctl restart clash >> /dev/null 2>&1
     echo -e "${green}Clashå®‰è£…æˆåŠŸ!${end}"
     echo -e "${green}Clashåˆå§‹åŒ–!${end}" &&sleep 30
}

update_clash_y() {
	new_clash_ver=$( wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep clash_v | awk '{print $2}')
        if [[ ! -n "$new_clash_ver" ]]; then
        echo -e "${red}Clashæ£€æµ‹ç‰ˆæœ¬å¤±è´¥!${end}"
        exit 1
        fi  
	if [ ! -d "/tmp/clash" ]; then
        mkdir /tmp/clash
        fi            
        webget2 /tmp/clash/clash.gz "$url_cdn/https://github.com/Dreamacro/clash/releases/download/premium/clash-linux-${cpucore}-${new_clash_ver}.gz"
        if [[ $? -ne 0 ]]; then
        echo -e "${red}Clashä¸‹è½½å¤±è´¥!${end}"
        exit 1
        fi
        echo -e "${green}Clashä¸‹è½½æˆåŠŸ!${end}" 
        rm -rf /usr/bin/clash
        gunzip /tmp/clash/clash.gz
        mv /tmp/clash/clash /usr/bin/clash
        chmod +x /usr/bin/clash
        rm -rf /tmp/clash
        supervisorctl restart clash >> /dev/null 2>&1
        echo -e "${green}å‡çº§ClashæˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬!${end}" && exit 0

}

update_clash() {
	new_clash_ver=$( wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep clash_v | awk '{print $2}')
        now_clash_ver=$(clash -v | awk '{print $2}')
	if [[ "${now_clash_ver}" != "${new_clash_ver}" ]]  ;then
	echo -e "Clashå·²æœ‰æ–°ç‰ˆæœ¬: ${new_clash_ver}ï¼Œå½“å‰ç‰ˆæœ¬:${now_clash_ver}ï¼Œå¼€å§‹å®‰è£…"
        if [[ ! -n "$new_clash_ver" ]]; then
        echo -e "${red}Clashæ£€æµ‹ç‰ˆæœ¬å¤±è´¥!${end}"
        exit 1
        fi
        if [ ! -d "/tmp/clash" ]; then
        mkdir /tmp/clash
        fi 
        webget2 /tmp/clash/clash.gz "$url_cdn/https://github.com/Dreamacro/clash/releases/download/premium/clash-linux-${cpucore}-${new_clash_ver}.gz"
        if [[ $? -ne 0 ]]; then
        echo -e "${red}Clashä¸‹è½½å¤±è´¥!${end}"
        exit 1
        fi
        echo -e "${green}Clashä¸‹è½½æˆåŠŸ!${end}" 
        rm -rf /usr/bin/clash
        gunzip /tmp/clash/clash.gz
        mv /tmp/clash/clash /usr/bin/clash
        chmod +x /usr/bin/clash
        supervisorctl restart clash >> /dev/null 2>&1
        echo -e "${green}Clashå‡çº§æˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬!${end}" && exit 0
        fi
}

install_mosdns() {
    new_mosdns_ver=$(wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep mosdns_v | awk '{print $2}')
    if [[ ! -n "$new_mosdns_ver" ]]; then
    echo -e "${red}Mosdnsæ£€æµ‹ç‰ˆæœ¬å¤±è´¥!${end}"
    exit 1
    fi
    if [ ! -d "/tmp/mosdns" ]; then
     mkdir /tmp/mosdns
     fi 
     webget2   /tmp/mosdns/mosdns.tar.gz ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/mosdns/mosdns.tar.gz  >> /dev/null 2>&1
     if [[ $? -ne 0 ]]; then
     echo -e "${red}Mosdnsé…ç½®ä¸‹è½½å¤±è´¥!${end}"
     exit 1
     fi
     echo -e "${green}Mosdnsé…ç½®ä¸‹è½½æˆåŠŸ!${end}" 
     cd /tmp/mosdns
     tar zxvf mosdns.tar.gz  >> /dev/null 2>&1
     if [ ! -d "/srv/mosdns" ]; then
     mkdir /srv/mosdns
     fi 
     mv /tmp/mosdns/mosdns /srv/
     webget2  /tmp/mosdns/mosdns.zip "$url_cdn/https://github.com/IrineSistiana/mosdns/releases/download/${new_mosdns_ver}/mosdns-linux-${cpucore2}.zip"
     if [[ $? -ne 0 ]]; then
     echo -e "${red}Mosdnsä¸‹è½½å¤±è´¥!${end}"
     exit 1
     fi
     echo -e "${green}Mosdnsä¸‹è½½æˆåŠŸ!${end}" 
     cd /tmp/mosdns
     rm -rf /usr/bin/mosdns
     unzip /tmp/mosdns/mosdns.zip  >> /dev/null 2>&1
     mv mosdns /usr/bin/mosdns
     chmod 777 /usr/bin/mosdns
     rm -rf /tmp/mosdns
     supervisor_mosdns_config
     mosdns_config
     supervisorctl update >> /dev/null 2>&1
     supervisorctl restart mosdns >> /dev/null 2>&1
     echo -e "${green}Mosdnså®‰è£…æˆåŠŸ!${end}"
}




update_mosdns_y() {
        new_mosdns_ver=$(wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep mosdns_v | awk '{print $2}')
        if [[ ! -n "$new_mosdns_ver" ]]; then
        echo -e "${red}Mosdnsæ£€æµ‹ç‰ˆæœ¬å¤±è´¥!${end}"
        exit 1
        fi
        if [ ! -d "/tmp/mosdns" ]; then
        mkdir /tmp/mosdns
        fi         
        webget2  /tmp/mosdns/mosdns.zip "$url_cdn/https://github.com/IrineSistiana/mosdns/releases/download/${new_mosdns_ver}/mosdns-linux-${cpucore2}.zip"
        if [[ $? -ne 0 ]]; then
        echo -e "${red}Mosdnsä¸‹è½½å¤±è´¥!${end}"
        exit 1
        fi
        echo -e "${green}Mosdnsä¸‹è½½æˆåŠŸ!${end}" 
        cd /tmp/mosdns
        rm -rf /usr/bin/mosdns
        rm -rf /srv/mosdns/config.yaml
        mosdns_config
        unzip /tmp/mosdns/mosdns.zip  >> /dev/null 2>&1
        mv mosdns /usr/bin/mosdns
        chmod 777 /usr/bin/mosdns
        rm -rf /tmp/mosdns
        supervisorctl restart mosdns >> /dev/null 2>&1
        echo -e "${green}Mosdnså‡çº§æˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬!${end}" && exit 0

}


update_mosdns() {
        new_mosdns_ver=$(wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep mosdns_v | awk '{print $2}')
        now_mosdns_ver=$(mosdns -v | awk '{print $1}'| cut -d'-' -f1)
	      if [[ "${now_mosdns_ver}" != "${new_mosdns_ver}" ]]  ;then
	      echo -e "Mosdnså·²æœ‰æ–°ç‰ˆæœ¬: ${new_mosdns_ver}ï¼Œå½“å‰ç‰ˆæœ¬:${now_mosdns_ver}ï¼Œå¼€å§‹å®‰è£…"
        if [[ ! -n "$new_mosdns_ver" ]]; then
        echo -e "${red}Mosdnsæ£€æµ‹ç‰ˆæœ¬å¤±è´¥!${end}"
        exit 1
        fi
        if [ ! -d "/tmp/mosdns" ]; then
        mkdir /tmp/mosdns
        fi         
        webget2  /tmp/mosdns/mosdns.zip "$url_cdn/https://github.com/IrineSistiana/mosdns/releases/download/${new_mosdns_ver}/mosdns-linux-${cpucore2}.zip"
	      #[ "$result" != "200" ] && echo "æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼" && exit 1
        if [[ $? -ne 0 ]]; then
        echo -e "${red}Mosdnsä¸‹è½½å¤±è´¥!${end}"
        exit 1
        fi
        echo -e "${green}Mosdnsä¸‹è½½æˆåŠŸ!${end}" 
        cd /tmp/mosdns
        rm -rf /usr/bin/mosdns
        rm -rf /srv/mosdns/config.yaml
        mosdns_config
        unzip /tmp/mosdns/mosdns.zip  >> /dev/null 2>&1
        mv /tmp/mosdns/mosdns /usr/bin/mosdns
        chmod 777 /usr/bin/mosdns
        rm -rf /tmp/mosdns
        supervisorctl restart mosdns >> /dev/null 2>&1
        echo -e "${green}Mosdnså‡çº§æˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬!${end}" && exit 0
        fi

}

update_shell_y() {
 	new_shell_ver=$(wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep version | awk '{print $2}')
        webget2  /tmp/clash_ui  $url_cdn/https://raw.githubusercontent.com/fjjonline/c-m/main/clash_ui
        if [[ $? -ne 0 ]]; then
        echo -e "${red}Clash_UIä¸‹è½½å¤±è´¥!${end}"
        exit 1
        fi
        echo -e "`date +%F\ %T` Clash_UI v${new_shell_ver} ä¸‹è½½æˆåŠŸ!" >> /tmp/update.log  2>&1
        rm -rf /usr/bin/clash_ui   
        mv /tmp/clash_ui /usr/bin/clash_ui  >> /dev/null 2>&1
        chmod +x /usr/bin/clash_ui >> /dev/null 2>&1
        echo -e "${green}Clash_UI v${new_shell_ver}å¼ºåˆ¶å‡çº§æˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬!${end}" && exit 0
}

update_shell() {
	new_shell_ver=$(wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep version | awk '{print $2}')
	if [[ "${sh_ver}" != "${new_shell_ver}" ]]  ;then
	echo -e "`date +%F\ %T` Clash_UI  æœ€æ–°ç‰ˆæœ¬: ${new_shell_ver}ï¼Œå½“å‰ç‰ˆæœ¬:${sh_ver}"
        webget2 /tmp/clash_ui $url_cdn/https://raw.githubusercontent.com/fjjonline/c-m/main/clash_ui
        if [[ $? -ne 0 ]]; then
        echo -e "${red}Clash_UIä¸‹è½½å¤±è´¥!${end}"
        exit 1
        fi
        echo -e "`date +%F\ %T` Clash_UI v${new_shell_ver} ä¸‹è½½æˆåŠŸ!" >> /tmp/update.log  2>&1
        rm -rf /usr/bin/clash_ui   
        mv /tmp/clash_ui /usr/bin/clash_ui  >> /dev/null 2>&1
        chmod +x /usr/bin/clash_ui >> /dev/null 2>&1
        echo -e "${green}Clash_UI v${new_shell_ver}å‡çº§æˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬!${end}" && exit 0
        fi
}

install_nftables() {
     if [ ! -d "/tmp/nftables" ]; then
     mkdir /tmp/nftables
     fi
     mkdir -p /etc/nftables
     webget2 /tmp/nftables/nftables.zip  ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/nftables/nftables.zip >> /dev/null 2>&1
     if [[ $? -ne 0 ]]; then
     echo -e "${red}Nftablesä¸‹è½½å¤±è´¥!${end}"
     exit 1
     fi
     echo -e "${green}Nftablesä¸‹è½½æˆåŠŸ!${end}" 
     cd /tmp/nftables
     unzip nftables.zip >> /dev/null 2>&1
     mv /tmp/nftables/nftables/chnroute.nft /etc/nftables/chnroute.nft
     mv /tmp/nftables/nftables/private.nft /etc/nftables/private.nft
     mv /tmp/nftables/nftables/nftables.conf /etc/nftables.conf
     ip route replace default dev utun table 114  >> /dev/null 2>&1
     ip rule del fwmark 114514 lookup 114  >> /dev/null 2>&1
     ip rule add fwmark 114514 lookup 114 >> /dev/null 2>&1
     sudo sh -c "nft flush ruleset && nft -f /etc/nftables.conf" >> /dev/null 2>&1
     systemctl enable nftables.service >> /dev/null 2>&1
     systemctl start nftables.service >> /dev/null 2>&1
     rm -rf /tmp/nftables
     echo -e "${green}Nftableså®‰è£…æˆåŠŸ!${end}"
}


install_cron() {
cat << EOF > /var/spool/cron/crontabs/root
*/5 * * * * clash_ui ping
*/60 * * * * clash_ui update
0 5 * * * clash_ui check_ver
EOF
chmod 777 /var/spool/cron/crontabs/root
crontab /var/spool/cron/crontabs/root
/etc/init.d/cron restart  >> /dev/null 2>&1
}


#sed -i '$a\0 6 * * * clash_ui restart' /var/spool/cron/crontabs/root
#sed -i  s/'clash_ui restart'/'clash_ui check_ver'/g  /var/spool/cron/crontabs/root

check_clash_ver() {

       new_clash_ver=$(wget -qO- https://api.github.com/repos/Dreamacro/clash/releases | grep '"name": "Premium' | sed -E 's/.*"Premium ([^"]+)".*/\1/')
       #new_clash_ver=$( wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep clash_v | awk '{print $2}')
       now_clash_ver=$(clash -v | awk '{print $2}')
       if [ ! -d "/srv/version" ]; then
       cat << EOF > /srv/version
clash_v 
mosdns_v 
EOF
       fi  
       sed -i  's/'clash_v'/'"clash_v ${new_clash_ver}"'/g'  /srv/version

}

check_mosdns_ver() {
       new_mosdns_ver=$(wget -qO- https://api.github.com/repos/IrineSistiana/mosdns/releases | grep '"tag_name": ' | sed -E 's/.*"([^"]+)".*/\1/' | head -n 1)
       #new_mosdns_ver=$(wget -qO- ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/version | grep mosdns_v | awk '{print $2}')
       now_mosdns_ver=$(mosdns -v | awk '{print $1}'| cut -d'-' -f1)
       sed -i  's/'mosdns_v'/'"mosdns_v ${new_mosdns_ver}"'/g'  /srv/version

}

check_ver() {
update_shell  
check_clash_ver
check_mosdns_ver
update_clash
update_mosdns
}




check_clash_status2() {
pIDa=`lsof -i :9090|grep -v "PID" | awk '{print $2}'`
if [ "$pIDa" = "" ];then
   return 1
else
   return 0
fi

}
check_ping_status() {
ping -q -c5 ${gateway} >> /dev/null 2>&1
if [ $? -eq 0 ];then
   return 0
else
   return 1
fi
}

ping_service() {
check_clash_status2
if [ $? -eq 0 ];then
echo `date +%F\ %T`  "æ£€æµ‹Clashç«¯å£æ­£å¸¸" >> /dev/null 2>&1
else
echo `date +%F\ %T`  "æ£€æµ‹Clashç«¯å£ä¸æ­£å¸¸ï¼Œæ­£åœ¨é‡å¯æœåŠ¡!" >>/tmp/ping.log
clash_ui restart
fi
check_ping_status
if [ $? -eq 0 ];then
echo `date +%F\ %T`  "æµ‹è¯•${gateway}ç½‘å…³æ­£å¸¸" >> /dev/null 2>&1
else
echo `date +%F\ %T`  "æµ‹è¯•${gateway}ç½‘å…³ä¸æ­£å¸¸ï¼Œæ­£åœ¨é‡å¯ç½‘ç»œæœåŠ¡!" >>/tmp/ping.log
/etc/init.d/networking restart
clash_ui restart
fi
}



dler_config() {
    read -e -p "æ˜¯å¦ä½¿ç”¨dlerè®¢é˜…? [Y/n] :" yn
    [[ -z "${yn}" ]] && yn="y"
    if [[ $yn == [Yy] ]]; then
    read -e -p "è¯·è¾“å…¥dlerè®¢é˜…TOKEN:" token
    fi
    if [ ! "$token" ];then
    if [ ! -d "/srv/clash" ]; then
    mkdir /srv/clash
    fi    
    mv /root/config.yaml /srv/clash/config.yaml     
    else
    dler_clash_config
    fi    
}



update_config () {
    update_clash_config
    update_mosdns_config
    }

update_clash_config () {
    update_shell
    echo -e "${green}æ›´æ–°clashé…ç½®!${end}"	 
    mv /srv/clash/config.yaml /tmp/clash_config.yaml.`date "+%Y.%m.%d.%H:%M"`
    rm -rf /srv/clash/*.yaml
    webget2 /srv/clash/Country.mmdb ${url_cdn}/https://raw.githubusercontent.com/fjjonline/c-m/main/clash/Country.mmdb  >> /dev/null 2>&1
    dler_clash_config
    clash_ui restart_clash
   
    }




update_mosdns_config () {
    update_shell
    echo -e "${green}æ›´æ–°mosdnsé…ç½®!${end}"	
    mv /srv/mosdns/config.yaml /tmp/mosdns_config.yaml.`date "+%Y.%m.%d.%H:%M"`
    mosdns_config
    echo -e "${green}æ›´æ–°geoip.dat${end}"	
    webget2 /srv/mosdns/geoip.dat "$url_cdn/https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat"  
    echo -e "${green}æ›´æ–°geosite.dat${end}"	
    webget2 /srv/mosdns/geosite.dat "$url_cdn/https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat"
    clash_ui restart_mosdns
    }


install() {
    check_clash_status2    
    if [[ $? == 0 ]]; then
    echo -e "${green}Clash_UIå·²å®‰è£…"
    exit 1
    else
    echo "---------------------------------------"		
    echo -e "${green}       Clash+Mosdns ä¸€é”®å®‰è£…"
    echo -e "${green}æŒ‰ç…§æç¤ºè¾“å…¥IP,å­ç½‘,ç½‘å…³"
    echo -e "${green}dlerè®¢é˜…æŒ‰ç…§æç¤ºè¾“å…¥token"		
    echo -e "${green}è¯·å°†config.yamlé…ç½®æ–‡ä»¶ä¸Šä¼ åˆ°/root"		
    echo "---------------------------------------"
    update_shell
    read -e -p "è¾“å…¥æœ¬æœºIP:" ip_add
    read -e -p "è¾“å…¥å­ç½‘ç :" ip_mask
    read -e -p "è¾“å…¥ç½‘å…³:" ip_gw
    read -e -p "è¾“å…¥DNS:" ip_dns
    dler_config
    check_disk_status
    config_ip_dns
    config_base
    install_debian
    install_clash
    install_mosdns		
    install_nftables
    install_cron
    echo "---------------------------------------"
    echo -e "${green}       Clash+Mosdns å®‰è£…æˆåŠŸ"
    echo -e "${green}Clashé…ç½®æ–‡ä»¶ï¼š/srv/clash/config.yaml"
    echo -e "${green}Clashæ§åˆ¶é¢æ¿:http://${ip_add}:9090/ui/"		
    echo "---------------------------------------"
    reboot_show_menu
    fi  
}

getipv4(){
	ipv4=$(wget -qO- -4 -t1 -T2 members.3322.org/dyndns/getip)
	#IP_address=$(wget -qO- -t1 -T2 http://freeapi.ipip.net/${ipv4}|sed 's/\"//g;s/,//g;s/\[//g;s/\]//g')
	if [[ -z "${ipv4}" ]]; then
		ipv4=$(wget -qO- -4 -t1 -T2 api.ip.sb/ip)
		#IP_address=$(wget -qO- -t1 -T2 http://freeapi.ipip.net/${ipv4}|sed 's/\"//g;s/,//g;s/\[//g;s/\]//g')
		if [[ -z "${ipv4}" ]]; then
			ipv4=$(wget -qO- -4 -t1 -T2 members.3322.org/dyndns/getip)
			#IP_address=$(wget -qO- -t1 -T2 http://freeapi.ipip.net/${ipv4}|sed 's/\"//g;s/,//g;s/\[//g;s/\]//g')
			if [[ -z "${ipv4}" ]]; then
				ipv4="IPv4_Error"
			fi
		fi
	fi
}

get_IP_address(){
	if [[ ! -z ${ipv4} ]]; then
		for((integer_1 = ${user_IP_total}; integer_1 >= 1; integer_1--))
		do
			IP=$(echo "${ipv4}" |sed -n "$integer_1"p)
			IP_address=$(wget -qO- -t1 -T2 http://freeapi.ipip.net/${ipv4}|sed 's/\"//g;s/,//g;s/\[//g;s/\]//g')
			echo -e "${green}${ipv4} (${IP_address})"
			sleep 1s
		done
	fi
}


before_show_menu() {
    echo -n -e "${yellow}æŒ‰å›è½¦è¿”å›ä¸»èœå•:${end}" && read temp
    show_menu
}

reboot_show_menu() {
    echo -n -e "${yellow}æŒ‰å›è½¦é‡å¯ç³»ç»Ÿ!${end}"  && read temp	
    reboot          
}



restart_clash() {
    supervisorctl restart clash >> /dev/null 2>&1
    sleep 2
    check_clash_status
    if [[ $? == 0 ]]; then
    echo -e "${green}Clash é‡å¯æˆåŠŸ!${end}"
    else
    echo -e "${red}é‡å¯å¤±è´¥!${end}"
    fi
    if [[ $# == 0 ]]; then
    before_show_menu
    fi
}


restart_mosdns() {
    supervisorctl restart mosdns >> /dev/null 2>&1
    sleep 2
    check_mosdns_status
    if [[ $? == 0 ]]; then
    echo -e "${green}Mosdns é‡å¯æˆåŠŸ!${end}"
    else
    echo -e "${red}é‡å¯å¤±è´¥!${end}"
    fi
    if [[ $# == 0 ]]; then
    before_show_menu
    fi
}


status() {
    supervisorctl status clash
    if [[ $# == 0 ]]; then
    before_show_menu
    fi
}



show_status() {
    show_clash_status
    show_mosdns_status

}

restart_all() {
    supervisorctl restart clash >> /dev/null 2>&1
    supervisorctl restart mosdns >> /dev/null 2>&1
    echo -e "${green}Clash+Mosdns é‡å¯æˆåŠŸ!${end}"
}

show_clash_status() {
    check_clash_status
    if [[ $? == 0 ]]; then
    echo -e "${yellow} Clash çŠ¶æ€: ${green}å·²è¿è¡Œ${end}"
    else
    echo -e "${yellow} Clash çŠ¶æ€: ${red}æœªè¿è¡Œ${end}"
    fi
}

check_clash_status() {
    temp=$(supervisorctl status clash | awk '{print $2}' | cut -d "(" -f2 | cut -d ")" -f1)
    if [[ x"${temp}" == x"RUNNING" ]]; then
        return 0
    else
        return 1
    fi
}

check_install() {
    check_clash_status2    
    if [[ $? != 0 ]]; then
    echo -e "${green}Clash_UIæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…å†ä½¿ç”¨Clash_UI!"
    exit 1
    fi
}


show_mosdns_status() {
    check_mosdns_status
    if [[ $? == 0 ]]; then
    echo -e "${yellow}Mosdns çŠ¶æ€: ${green}å·²è¿è¡Œ${end}"
    else
    echo -e "${yellow}Mosdns çŠ¶æ€: ${red}æœªè¿è¡Œ${end}"
    fi
}
check_mosdns_status() {
    temp=$(supervisorctl status mosdns | awk '{print $2}' | cut -d "(" -f2 | cut -d ")" -f1)
    if [[ x"${temp}" == x"RUNNING" ]]; then
        return 0
    else
        return 1
    fi
}

check_disk_status() {
   echo -e "${yellow}å‰©ä½™ç©ºé—´:${end} $(df -h /srv | awk '{print $4}' | sed 1d )${yellow}    æ¶æ„:${end} ${cpucore2}"

}



show_usage() {
    echo -e "${blueb}Clash_UI ç®¡ç†è„šæœ¬ V${sh_ver} J. "
    echo "-------------------------------------------------"
    echo -e "${green}clash_ui                      - æ˜¾ç¤ºç®¡ç†èœå•"
    echo -e "${green}clash_ui install              - å®‰è£… Clash+Mosdns"    
    echo -e "${green}clash_ui restart_clash        - é‡å¯ Clash"
    echo -e "${green}clash_ui restart_mosdns       - é‡å¯ Mosdns"
    echo -e "${green}clash_ui restart              - é‡å¯ Clash+Mosdns"
    echo -e "${green}clash_ui status               - æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
    echo -e "${green}clash_ui logs                 - æŸ¥çœ‹ Clash æ—¥å¿—"    
    echo -e "${green}clash_ui update_kernel        - æ›´æ–° Debian å†…æ ¸"
    echo -e "${green}clash_ui update_clash         - æ›´æ–° Clash"
    echo -e "${green}clash_ui update_mosdns        - æ›´æ–° Mosdns"
    echo -e "${green}clash_ui update_config        - æ›´æ–° Clash+Mosdnsé…ç½®"
    echo -e "${green}clash_ui update               - æ›´æ–° Clash_UI ç®¡ç†è„šæœ¬"
    echo "-------------------------------------------------"
}

show_menu() {
    echo -e "
  ${lightblueb}Clash_UI ${yellow}ç®¡ç†è„šæœ¬ J.${end}
  ${green}q. ${redb}é€€å‡ºè„šæœ¬${end}
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  ${green}1. é‡å¯ ${end}Clash
  ${green}2. é‡å¯ ${end}Mosdns
  ${green}3. é‡å¯ ${end}Clash+Mosdns
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  ${green}4. æ—¥å¿— ${end}Clash
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  ${green}5. æ›´æ–° ${end}Clash_UI
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  ${green}6. æ›´æ–° ${end}Clash
  ${green}7. æ›´æ–° ${end}Mosdns
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  ${green}8. æ›´æ–° ${end}Clashé…ç½®
  ${green}9. æ›´æ–° ${end}Mosdnsé…ç½®"
    echo -e "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"
    getipv4
    getcpucore
    getcpucore2
    show_status
    echo -e "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"
    update_shell
    update_clash
    update_mosdns
    check_disk_status
    echo -e "${yellow}ç½‘ç»œä¿¡æ¯: ${end}${local_ip} > ${ipv4}"     
    echo -e "   ${yellow}Clash: ${end}$(clash -v | awk '{print $2}') >  ${new_clash_ver}"
    echo -e "  ${yellow}Mosdns: ${end}$(mosdns -v | awk '{print $1}'| cut -d'-' -f1)     >  ${new_mosdns_ver}"
    echo -e "${yellow}Clash_UI: ${end}v${sh_ver}     >  v${new_shell_ver}" ${end}    
    echo && read -p "è¯·è¾“å…¥é€‰æ‹© [1-10]: " num

    case "${num}" in
        q) exit 1
        ;;
        1) restart_clash &&before_show_menu
        ;;
        2) restart_mosdns &&before_show_menu
        ;;
        3) restart_all &&before_show_menu   
        ;;
        4) tail -f /tmp/clash.log       
        ;;
        5) update_shell_y
        ;;
        6) update_clash_y
        ;;                
        7) update_mosdns_y
        ;;                   
        8) update_clash_config
        ;;
        9) update_mosdns_config
        ;;                    
        *) echo -e "${red}è¯·è¾“å…¥æ­£ç¡®çš„æ•°å­— [1-10]${end}" &&before_show_menu
        ;;
    esac
}


if [[ $# > 0 ]]; then
    case $1 in
        "update_clash") update_clash_y 0 
        ;;
        "update_mosdns") update_mosdns_y 0 
        ;;
        "restart_clash") restart_clash 0
        ;;
        "restart_mosdns") restart_mosdns 0
        ;;
        "restart") restart_all 0
        ;;        
        "logs") tail -f /tmp/clash.log 0
        ;;   
        "ping") ping_service 0
        ;; 
        "install") install 0
        ;;
        "install_ping") update_shell &&install_cron 0
        ;;                  
        "status") show_status 0
        ;;
        "check_ver") check_ver 0
        ;;              
        "update_clash_config") update_clash_config 0
        ;;
        "update_mosdns_config") update_mosdns_config 0
        ;;
        "update_config") update_config 0
        ;;                   
        "update") update_shell 0
        ;;                  
        *) show_usage
        ;;
    esac
else
    show_menu
fi
